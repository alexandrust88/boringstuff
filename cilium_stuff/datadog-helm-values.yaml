# =============================================================================
# Datadog Agent Helm Values - AKS Managed Cilium 1.17 (metrics only)
# =============================================================================
# deploy:
#   helm repo add datadog https://helm.datadoghq.com
#   helm install datadog datadog/datadog -f datadog-helm-values.yaml -n datadog --create-namespace
#
# AKS-managed Cilium facts:
#   - cilium-agent DaemonSet in kube-system     -> port 9962 (EXPOSED)
#   - cilium-operator Deployment in kube-system -> port 9963 (Cilium 1.12+)
#   - hubble embedded in cilium-agent           -> port 9965 (NOT exposed by AKS)
#   - you cannot change cilium config on AKS, only observe what AKS exposes
#   - port 6942 is legacy (pre-1.12), do NOT use for Cilium 1.17
#
# BEFORE DEPLOYING - check your actual pod labels:
#   kubectl -n kube-system get pods -l k8s-app=cilium --show-labels
#   kubectl -n kube-system get pods --show-labels | grep -i cilium-operator
#   kubectl exec -n kube-system ds/cilium -- curl -s localhost:9962/metrics | head -5
#   kubectl exec -n kube-system ds/cilium -- curl -s localhost:9963/metrics | head -5
#   kubectl exec -n kube-system ds/cilium -- curl -s localhost:9965/metrics | head -5
#
# references:
#   - https://docs.datadoghq.com/integrations/cilium/
#   - https://docs.datadoghq.com/containers/kubernetes/distributions/?tab=helm
#   - https://docs.cilium.io/en/stable/observability/metrics/
#   - https://github.com/Azure/AKS/issues/4708 (hubble port 9965 not exposed)
# =============================================================================

# --- AKS provider (MANDATORY) ---
# the chart cannot auto-detect AKS; without this the admission controller
# webhook conflicts with AKS automatic mutation
providers:
  aks:
    enabled: true

datadog:
  # --- credentials ---
  # kubectl create secret generic datadog-secret \
  #   --from-literal api-key=<API_KEY> \
  #   --from-literal app-key=<APP_KEY> \
  #   -n datadog
  apiKeyExistingSecret: datadog-secret

  # CHANGE: your datadog site
  site: datadoghq.eu

  # CHANGE: your cluster name
  clusterName: aks-my-cluster

  # --- kubelet ---
  # AKS: disable TLS verify (kubelet serving cert rotation usually not enabled)
  kubelet:
    tlsVerify: false

  # --- kube-state-metrics core check (runs inside cluster agent) ---
  # provides kubernetes_state.* metrics (node conditions, pod status, etc.)
  kubeStateMetricsCore:
    enabled: true

  # --- prometheus scraping (modern approach for cilium) ---
  prometheusScrape:
    enabled: true
    serviceEndpoints: false          # scrape pod IPs directly, not service endpoints

    additionalConfigs:
      # -----------------------------------------------------------------
      # cilium agent (DaemonSet, port 9962)
      # -----------------------------------------------------------------
      # matches by container name "cilium-agent" (works regardless of annotations)
      # metrics land in datadog as: cilium.<metric_name>
      - autodiscovery:
          kubernetes_container_names:
            - cilium-agent
        configurations:
          - openmetrics_endpoint: "http://%%host%%:9962/metrics"
            namespace: "cilium"
            metrics:
              - "cilium_*"
            send_distribution_buckets: true
            min_collection_interval: 15
            tags:
              - "component:cilium-agent"

      # -----------------------------------------------------------------
      # cilium operator (Deployment, port 9963)
      # -----------------------------------------------------------------
      # port 9963 is the default for Cilium 1.12+ (NOT 6942)
      # metrics land in datadog as: cilium_operator.<metric_name>
      - autodiscovery:
          kubernetes_container_names:
            - cilium-operator
        configurations:
          - openmetrics_endpoint: "http://%%host%%:9963/metrics"
            namespace: "cilium_operator"
            metrics:
              - "cilium_*"
            send_distribution_buckets: true
            min_collection_interval: 15
            tags:
              - "component:cilium-operator"

      # -----------------------------------------------------------------
      # hubble (embedded in cilium-agent, port 9965)
      # -----------------------------------------------------------------
      # WARNING: AKS-managed Cilium does NOT expose port 9965 by default.
      # See: https://github.com/Azure/AKS/issues/4708
      # Verify first:
      #   kubectl exec -n kube-system ds/cilium -- curl -s localhost:9965/metrics
      # If it returns metrics, uncomment this block.
      # metrics would land as: cilium_hubble.<metric_name>
      #
      # - autodiscovery:
      #     kubernetes_container_names:
      #       - cilium-agent
      #   configurations:
      #     - openmetrics_endpoint: "http://%%host%%:9965/metrics"
      #       namespace: "cilium_hubble"
      #       metrics:
      #         - "hubble_*"
      #       send_distribution_buckets: true
      #       min_collection_interval: 15
      #       tags:
      #         - "component:hubble"

# --- cluster agent ---
clusterAgent:
  enabled: true

# --- agent daemonset ---
agents:
  enabled: true
  tolerations:
    - operator: Exists              # run on all nodes including cilium nodes


# =============================================================================
# ALTERNATIVE: use the built-in Cilium integration instead of prometheusScrape
# =============================================================================
# the datadog agent ships with a native cilium check (ad_identifiers based).
# it auto-discovers cilium-agent by container image name.
# if prometheusScrape doesn't work or you prefer the native check, use confd:
#
# datadog:
#   confd:
#     cilium.yaml: |-
#       ad_identifiers:
#         - cilium-agent
#         - cilium
#       init_config:
#       instances:
#         - agent_endpoint: http://%%host%%:9962/metrics
#           use_openmetrics: true
#           tags:
#             - "component:cilium-agent"
#
#     cilium_operator.yaml: |-
#       ad_identifiers:
#         - cilium-operator
#       init_config:
#       instances:
#         - operator_endpoint: http://%%host%%:9963/metrics
#           use_openmetrics: true
#           tags:
#             - "component:cilium-operator"
#
# =============================================================================


# =============================================================================
# verification commands
# =============================================================================
# 1. check cilium pod labels (update autodiscovery if needed):
#    kubectl -n kube-system get pods -l k8s-app=cilium --show-labels
#    kubectl -n kube-system get pods --show-labels | grep -i cilium-operator
#
# 2. verify cilium exposes metrics:
#    kubectl exec -n kube-system ds/cilium -- curl -s localhost:9962/metrics | head -20
#    kubectl exec -n kube-system ds/cilium -- curl -s localhost:9965/metrics | head -20
#
# 3. verify operator metrics (find pod name first):
#    kubectl -n kube-system get pods | grep cilium-operator
#    kubectl exec -n kube-system <operator-pod> -- curl -s localhost:9963/metrics | head -20
#
# 4. verify datadog is scraping:
#    kubectl exec -n datadog ds/datadog -- agent status | grep -A10 openmetrics
#    kubectl exec -n datadog ds/datadog -- agent check openmetrics
#
# 5. common AKS cilium pod label alternatives:
#    agent:    k8s-app=cilium | app.kubernetes.io/name=cilium-agent
#    operator: name=cilium-operator | io.cilium/app=operator | k8s-app=cilium-operator
# =============================================================================
