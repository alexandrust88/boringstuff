{
  "title": "Cilium Deep Insights (AKS / Fleet)",
  "description": "Advanced Cilium dashboard for AKS fleets. Goes beyond the default integration page with: security posture scoring, anomaly detection, capacity planning, SLO tracking, and eBPF health. Uses correct metric names from the Datadog Cilium integration (OpenMetrics v2). NOTE: AKS-managed Cilium 1.17 - no hubble relay, no envoy L7 proxy, no clustermesh.",
  "layout_type": "ordered",
  "restricted_roles": [],
  "template_variables": [
    {
      "name": "cluster",
      "prefix": "kube_cluster_name",
      "available_values": [],
      "default": "*"
    },
    {
      "name": "node",
      "prefix": "host",
      "available_values": [],
      "default": "*"
    },
    {
      "name": "src_ns",
      "prefix": "source_namespace",
      "available_values": [],
      "default": "*"
    }
  ],
  "template_variable_presets": [
    {
      "name": "All Clusters",
      "template_variables": [
        {
          "name": "cluster",
          "value": "*"
        },
        {
          "name": "node",
          "value": "*"
        },
        {
          "name": "src_ns",
          "value": "*"
        }
      ]
    },
    {
      "name": "Production Only",
      "template_variables": [
        {
          "name": "cluster",
          "value": "prod-*"
        },
        {
          "name": "node",
          "value": "*"
        },
        {
          "name": "src_ns",
          "value": "*"
        }
      ]
    }
  ],
  "widgets": [
    {
      "definition": {
        "type": "note",
        "content": "## Cilium Deep Insights Dashboard\n\nThis dashboard goes beyond the default Cilium integration page. Set **$cluster** and optionally **$node** / **$src_ns** at the top.\n\n**Metric naming:** OpenMetrics V2. Agent metrics: `cilium.<name>.count`. Hubble metrics (openmetrics check with `namespace:cilium.hubble` + `raw_metric_prefix:hubble_`): `cilium.hubble.<name>.count`. If widgets show 'No data', verify helm values set `raw_metric_prefix: hubble_` on the hubble check.\n\n**Sections:** Security Posture \u2192 Agent/Operator Health \u2192 Drops & Network \u2192 Hubble Flows \u2192 DNS \u2192 TCP \u2192 eBPF Health \u2192 Policy \u2192 Capacity Planning \u2192 Kubernetes \u2192 Operator \u2192 Resources \u2192 Node Health (AKS)\n\n**AKS note:** No Envoy L7 proxy, no hubble relay (embedded in agent), no clustermesh. IPAM is Azure-delegated.\n\n**DNS rcode note:** Tag values depend on Cilium version. Verify with: `kubectl exec -n kube-system ds/cilium -- curl -s localhost:9965/metrics | grep dns_responses`",
        "background_color": "vivid_blue",
        "font_size": "14",
        "text_align": "left",
        "show_tick": false
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Security Posture",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "note",
              "content": "**Security Posture** tracks policy enforcement coverage, drop-to-forward ratios, and denial trends. A healthy cluster has >90% policy coverage, <0.1% drop ratio, and stable denial rates.",
              "background_color": "gray",
              "font_size": "14",
              "text_align": "left",
              "show_tick": false
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Policy Coverage %",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "(query1 - query2) / query1 * 100",
                      "limit": {
                        "count": 1,
                        "order": "desc"
                      },
                      "conditional_formats": [
                        {
                          "comparator": ">=",
                          "value": 90,
                          "palette": "white_on_green"
                        },
                        {
                          "comparator": ">=",
                          "value": 70,
                          "palette": "white_on_yellow"
                        },
                        {
                          "comparator": "<",
                          "value": 70,
                          "palette": "white_on_red"
                        }
                      ]
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.endpoint.count{kube_cluster_name:$cluster,host:$node}",
                      "aggregator": "last"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "sum:cilium.policy.endpoint_enforcement_status{kube_cluster_name:$cluster,host:$node,policy_enforcement_status:none}",
                      "aggregator": "last"
                    }
                  ],
                  "response_format": "scalar"
                }
              ],
              "precision": 1,
              "autoscale": false,
              "custom_unit": "%"
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Drop-to-Forward Ratio %",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / (query1 + query2) * 100",
                      "conditional_formats": [
                        {
                          "comparator": "<=",
                          "value": 0.1,
                          "palette": "white_on_green"
                        },
                        {
                          "comparator": "<=",
                          "value": 1,
                          "palette": "white_on_yellow"
                        },
                        {
                          "comparator": ">",
                          "value": 1,
                          "palette": "white_on_red"
                        }
                      ]
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.drop_count.count{kube_cluster_name:$cluster,host:$node}.as_rate()",
                      "aggregator": "avg"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "sum:cilium.forward_count.count{kube_cluster_name:$cluster,host:$node}.as_rate()",
                      "aggregator": "avg"
                    }
                  ],
                  "response_format": "scalar"
                }
              ],
              "precision": 3,
              "autoscale": false,
              "custom_unit": "%"
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Policy Denials (last timeframe)",
              "requests": [
                {
                  "q": "sum:cilium.hubble.policy_verdicts.count{verdict:dropped,kube_cluster_name:$cluster,source_namespace:$src_ns}.as_count()",
                  "aggregator": "sum",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": "<=",
                      "value": 50,
                      "palette": "white_on_yellow"
                    },
                    {
                      "comparator": ">",
                      "value": 50,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Policy Denials with Anomaly Detection",
              "requests": [
                {
                  "q": "anomalies(sum:cilium.hubble.policy_verdicts.count{verdict:dropped,kube_cluster_name:$cluster,source_namespace:$src_ns}.as_count(), 'agile', 3)",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "solid",
                    "line_width": "normal"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "change",
              "title": "Policy Denials - Week over Week",
              "requests": [
                {
                  "q": "sum:cilium.hubble.policy_verdicts.count{verdict:dropped,kube_cluster_name:$cluster,source_namespace:$src_ns}.as_count()",
                  "change_type": "absolute",
                  "compare_to": "week_before",
                  "order_by": "change",
                  "order_dir": "desc",
                  "increase_good": false
                }
              ]
            }
          },
          {
            "definition": {
              "type": "toplist",
              "title": "Top Denied Namespaces",
              "requests": [
                {
                  "q": "top(sum:cilium.hubble.policy_verdicts.count{verdict:dropped,kube_cluster_name:$cluster} by {source_namespace}.as_count(), 10, 'sum', 'desc')"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "treemap",
              "title": "Drop Reasons Distribution",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.drop_count.count{kube_cluster_name:$cluster} by {reason}.as_count()",
                      "aggregator": "sum"
                    }
                  ],
                  "response_format": "timeseries"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Agent / Operator Health",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "check_status",
              "title": "Cilium Agent Check Status",
              "check": "cilium.openmetrics.health",
              "grouping": "cluster",
              "group_by": [
                "kube_cluster_name"
              ],
              "tags": [
                "kube_cluster_name:$cluster"
              ]
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Failing Controllers",
              "requests": [
                {
                  "q": "max:cilium.controllers.failing.count{kube_cluster_name:$cluster,host:$node}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Unreachable Nodes",
              "requests": [
                {
                  "q": "max:cilium.unreachable.nodes{kube_cluster_name:$cluster,host:$node}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Ready Endpoints",
              "requests": [
                {
                  "q": "sum:cilium.endpoint.count{kube_cluster_name:$cluster}",
                  "aggregator": "last"
                }
              ],
              "precision": 0,
              "autoscale": true
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Active Policies",
              "requests": [
                {
                  "q": "max:cilium.policy.count{kube_cluster_name:$cluster}",
                  "aggregator": "last"
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Identities",
              "requests": [
                {
                  "q": "sum:cilium.identity.count{kube_cluster_name:$cluster}",
                  "aggregator": "last"
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Unreachable Nodes Over Time",
              "requests": [
                {
                  "q": "max:cilium.unreachable.nodes{kube_cluster_name:$cluster} by {host}",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Agent Restarts (by node)",
              "requests": [
                {
                  "q": "sum:kubernetes.containers.restarts{kube_cluster_name:$cluster,kube_container_name:cilium-agent,host:$node} by {host}",
                  "display_type": "bars"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Operator Restarts",
              "requests": [
                {
                  "q": "sum:kubernetes.containers.restarts{kube_cluster_name:$cluster,kube_container_name:cilium-operator} by {kube_cluster_name}",
                  "display_type": "bars"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Controller Execution Rate by Status",
              "requests": [
                {
                  "q": "sum:cilium.controllers.runs.count{kube_cluster_name:$cluster,host:$node} by {status}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Drops & Network Traffic (SRE Critical)",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "timeseries",
              "title": "Drop Rate with Anomaly Detection",
              "requests": [
                {
                  "q": "anomalies(sum:cilium.drop_count.count{kube_cluster_name:$cluster,host:$node}.as_rate(), 'agile', 3)",
                  "display_type": "line",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Drop Rate by Reason",
              "requests": [
                {
                  "q": "sum:cilium.drop_count.count{kube_cluster_name:$cluster,host:$node} by {reason}.as_rate()",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "toplist",
              "title": "Top Drop Reasons (15m)",
              "requests": [
                {
                  "q": "top(sum:cilium.drop_count.count{kube_cluster_name:$cluster} by {reason}.as_count(), 15, 'sum', 'desc')"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Drops by Direction (ingress/egress)",
              "requests": [
                {
                  "q": "sum:cilium.drop_count.count{kube_cluster_name:$cluster,host:$node,direction:ingress}.as_rate()",
                  "display_type": "area",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "sum:cilium.drop_count.count{kube_cluster_name:$cluster,host:$node,direction:egress}.as_rate()",
                  "display_type": "area",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Forwarded Bytes (ingress vs egress)",
              "requests": [
                {
                  "q": "sum:cilium.forward_bytes.count{direction:ingress,kube_cluster_name:$cluster,host:$node}.as_count()",
                  "display_type": "area",
                  "style": {
                    "palette": "cool",
                    "line_type": "solid"
                  }
                },
                {
                  "q": "sum:cilium.forward_bytes.count{direction:egress,kube_cluster_name:$cluster,host:$node}.as_count()",
                  "display_type": "area",
                  "style": {
                    "palette": "warm",
                    "line_type": "solid"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Forwarded Packets (ingress vs egress)",
              "requests": [
                {
                  "q": "sum:cilium.forward_count.count{direction:ingress,kube_cluster_name:$cluster,host:$node}.as_count()",
                  "display_type": "line"
                },
                {
                  "q": "sum:cilium.forward_count.count{direction:egress,kube_cluster_name:$cluster,host:$node}.as_count()",
                  "display_type": "line"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Hubble Flow Visibility",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "timeseries",
              "title": "Flow Verdicts (forwarded / dropped / error)",
              "requests": [
                {
                  "q": "sum:cilium.hubble.flows_processed.count{kube_cluster_name:$cluster,source_namespace:$src_ns} by {verdict}.as_count()",
                  "display_type": "area",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Flows to World (External) with Anomaly Band",
              "requests": [
                {
                  "q": "anomalies(sum:cilium.hubble.flows_to_world.count{kube_cluster_name:$cluster}.as_rate(), 'robust', 2)",
                  "display_type": "line",
                  "style": {
                    "palette": "orange"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Policy Verdicts: Forwarded vs Dropped",
              "requests": [
                {
                  "q": "sum:cilium.hubble.policy_verdicts.count{kube_cluster_name:$cluster,verdict:forwarded,source_namespace:$src_ns}.as_count()",
                  "display_type": "area",
                  "style": {
                    "palette": "green"
                  }
                },
                {
                  "q": "sum:cilium.hubble.policy_verdicts.count{kube_cluster_name:$cluster,verdict:dropped,source_namespace:$src_ns}.as_count()",
                  "display_type": "area",
                  "style": {
                    "palette": "red"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Flows by Namespace (top 10)",
              "requests": [
                {
                  "q": "top(sum:cilium.hubble.flows_processed.count{kube_cluster_name:$cluster} by {source_namespace}.as_count(), 10, 'sum', 'desc')",
                  "display_type": "bars",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Hubble Lost Events by Source",
              "requests": [
                {
                  "q": "sum:cilium.hubble.lost_events.count{kube_cluster_name:$cluster} by {source}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Hubble Lost Events %",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / (query1 + query2) * 100",
                      "conditional_formats": [
                        {
                          "comparator": "<=",
                          "value": 0.1,
                          "palette": "white_on_green"
                        },
                        {
                          "comparator": "<=",
                          "value": 1,
                          "palette": "white_on_yellow"
                        },
                        {
                          "comparator": ">",
                          "value": 1,
                          "palette": "white_on_red"
                        }
                      ]
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.hubble.lost_events.count{kube_cluster_name:$cluster}.as_count()",
                      "aggregator": "sum"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "sum:cilium.hubble.flows_processed.count{kube_cluster_name:$cluster}.as_count()",
                      "aggregator": "sum"
                    }
                  ],
                  "response_format": "scalar"
                }
              ],
              "precision": 2,
              "custom_unit": "%"
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "DNS Deep Analysis",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "query_value",
              "title": "DNS Success Rate %",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / query2 * 100",
                      "conditional_formats": [
                        {
                          "comparator": ">=",
                          "value": 99,
                          "palette": "white_on_green"
                        },
                        {
                          "comparator": ">=",
                          "value": 95,
                          "palette": "white_on_yellow"
                        },
                        {
                          "comparator": "<",
                          "value": 95,
                          "palette": "white_on_red"
                        }
                      ]
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.hubble.dns_responses.count{rcode:No Error,kube_cluster_name:$cluster,source_namespace:$src_ns}.as_count()",
                      "aggregator": "sum"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "sum:cilium.hubble.dns_responses.count{kube_cluster_name:$cluster}.as_count()",
                      "aggregator": "sum"
                    }
                  ],
                  "response_format": "scalar"
                }
              ],
              "precision": 1,
              "custom_unit": "%"
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "NXDOMAIN Rate %",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / query2 * 100",
                      "conditional_formats": [
                        {
                          "comparator": "<=",
                          "value": 5,
                          "palette": "white_on_green"
                        },
                        {
                          "comparator": "<=",
                          "value": 15,
                          "palette": "white_on_yellow"
                        },
                        {
                          "comparator": ">",
                          "value": 15,
                          "palette": "white_on_red"
                        }
                      ]
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.hubble.dns_responses.count{rcode:Non-Existent Domain,kube_cluster_name:$cluster}.as_count()",
                      "aggregator": "sum"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "sum:cilium.hubble.dns_responses.count{kube_cluster_name:$cluster}.as_count()",
                      "aggregator": "sum"
                    }
                  ],
                  "response_format": "scalar"
                }
              ],
              "precision": 1,
              "custom_unit": "%"
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "DNS Query Rate with Anomaly Detection",
              "requests": [
                {
                  "q": "anomalies(sum:cilium.hubble.dns_queries.count{kube_cluster_name:$cluster,source_namespace:$src_ns}.as_rate(), 'agile', 3)",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "DNS Responses by rcode",
              "requests": [
                {
                  "q": "sum:cilium.hubble.dns_responses.count{kube_cluster_name:$cluster} by {rcode}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "toplist",
              "title": "Top NXDOMAIN Sources (by namespace)",
              "requests": [
                {
                  "q": "top(sum:cilium.hubble.dns_responses.count{rcode:Non-Existent Domain,kube_cluster_name:$cluster} by {source_namespace}.as_count(), 10, 'sum', 'desc')"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "TCP",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "timeseries",
              "title": "TCP Flags Distribution",
              "requests": [
                {
                  "q": "sum:cilium.hubble.tcp_flags.count{kube_cluster_name:$cluster} by {flag}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "TCP RST Rate (Connection Issues Indicator)",
              "requests": [
                {
                  "q": "sum:cilium.hubble.tcp_flags.count{kube_cluster_name:$cluster,flag:RST}.as_rate()",
                  "display_type": "line",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "toplist",
              "title": "Top 10 Destination Ports",
              "requests": [
                {
                  "q": "top(sum:cilium.hubble.port_distribution.count{kube_cluster_name:$cluster} by {port}.as_count(), 10, 'sum', 'desc')"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "eBPF & Datapath Health (Critical)",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "query_value",
              "title": "Max BPF Map Pressure",
              "requests": [
                {
                  "q": "max:cilium.bpf.map_pressure{kube_cluster_name:$cluster,host:$node}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0.75,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": "<=",
                      "value": 0.9,
                      "palette": "white_on_yellow"
                    },
                    {
                      "comparator": ">",
                      "value": 0.9,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 3
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "BPF Map Pressure by Map Name (with critical threshold)",
              "requests": [
                {
                  "q": "avg:cilium.bpf.map_pressure{kube_cluster_name:$cluster,host:$node} by {map_name}",
                  "display_type": "line"
                }
              ],
              "markers": [
                {
                  "value": "y = 0.9",
                  "display_type": "error dashed",
                  "label": "CRITICAL (0.9)"
                },
                {
                  "value": "y = 0.75",
                  "display_type": "warning dashed",
                  "label": "WARNING (0.75)"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "BPF Map Pressure Forecast",
              "requests": [
                {
                  "q": "avg:cilium.bpf.map_pressure{kube_cluster_name:$cluster,map_name:cilium_ct4_global}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "forecast(avg:cilium.bpf.map_pressure{kube_cluster_name:$cluster,map_name:cilium_ct4_global}, 'linear', 3)",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "dashed"
                  }
                }
              ],
              "markers": [
                {
                  "value": "y = 0.9",
                  "display_type": "error dashed",
                  "label": "CRITICAL"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Conntrack Table Entries (per node)",
              "requests": [
                {
                  "q": "avg:cilium.datapath.conntrack_gc.entries{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "eBPF Memory Usage (Maps + Programs)",
              "requests": [
                {
                  "q": "avg:cilium.bpf.maps.virtual_memory.max.bytes{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "area",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:cilium.bpf.progs.virtual_memory.max.bytes{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "area",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "BPF Map Operations - Failures",
              "requests": [
                {
                  "q": "sum:cilium.bpf.map_ops.count{kube_cluster_name:$cluster,outcome:fail} by {map_name,operation}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Conntrack GC Duration (avg)",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / query2",
                      "alias": "Avg GC Duration (s)"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "avg:cilium.datapath.conntrack_gc.duration.seconds.sum{kube_cluster_name:$cluster,host:$node}",
                      "aggregator": "avg"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "avg:cilium.datapath.conntrack_gc.duration.seconds.count{kube_cluster_name:$cluster,host:$node}",
                      "aggregator": "avg"
                    }
                  ],
                  "response_format": "timeseries",
                  "display_type": "line"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Policy Enforcement",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "timeseries",
              "title": "Endpoint Enforcement Status",
              "requests": [
                {
                  "q": "sum:cilium.policy.endpoint_enforcement_status{kube_cluster_name:$cluster} by {policy_enforcement_status}",
                  "display_type": "bars",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Policy Changes by Outcome",
              "requests": [
                {
                  "q": "sum:cilium.policy.change.count{kube_cluster_name:$cluster} by {outcome}.as_count()",
                  "display_type": "bars"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Policy Import Errors",
              "requests": [
                {
                  "q": "sum:cilium.policy.import_errors.count{kube_cluster_name:$cluster}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Policy Implementation Delay (avg)",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / query2",
                      "alias": "Avg Policy Delay (s)"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "avg:cilium.policy.implementation_delay.sum{kube_cluster_name:$cluster}",
                      "aggregator": "avg"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "avg:cilium.policy.implementation_delay.count{kube_cluster_name:$cluster}",
                      "aggregator": "avg"
                    }
                  ],
                  "response_format": "timeseries",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Endpoint Regeneration Rate by Outcome",
              "requests": [
                {
                  "q": "sum:cilium.endpoint.regenerations.count{kube_cluster_name:$cluster,host:$node} by {outcome}.as_count()",
                  "display_type": "bars"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Endpoint Regeneration Failure Rate %",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / (query1 + query2) * 100",
                      "alias": "Failure Rate %"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "sum:cilium.endpoint.regenerations.count{kube_cluster_name:$cluster,outcome:fail}.as_count()",
                      "aggregator": "sum"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "sum:cilium.endpoint.regenerations.count{kube_cluster_name:$cluster,outcome:success}.as_count()",
                      "aggregator": "sum"
                    }
                  ],
                  "response_format": "timeseries",
                  "display_type": "line",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Endpoints by State",
              "requests": [
                {
                  "q": "sum:cilium.endpoint.state{kube_cluster_name:$cluster} by {endpoint_state}",
                  "display_type": "area",
                  "style": {
                    "palette": "dog_classic"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Capacity Planning",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "note",
              "content": "**Capacity Planning** tracks growth rates and projected exhaustion for identities (limit: 65535), BPF maps, endpoints, and IP addresses. Use forecasts to plan ahead.\n\n**AKS note:** IP addresses are managed by Azure VNET (delegated IPAM). cilium.ipam.capacity may not be populated.",
              "background_color": "gray",
              "font_size": "14",
              "text_align": "left",
              "show_tick": false
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Identity Count",
              "requests": [
                {
                  "q": "sum:cilium.identity.count{kube_cluster_name:$cluster}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 50000,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": "<=",
                      "value": 60000,
                      "palette": "white_on_yellow"
                    },
                    {
                      "comparator": ">",
                      "value": 60000,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Identity Count Growth with Forecast",
              "requests": [
                {
                  "q": "sum:cilium.identity.count{kube_cluster_name:$cluster}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "forecast(sum:cilium.identity.count{kube_cluster_name:$cluster}, 'linear', 3)",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "dashed"
                  }
                }
              ],
              "markers": [
                {
                  "value": "y = 65535",
                  "display_type": "error dashed",
                  "label": "Identity Limit"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Endpoint Count with Forecast",
              "requests": [
                {
                  "q": "sum:cilium.endpoint.count{kube_cluster_name:$cluster}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "forecast(sum:cilium.endpoint.count{kube_cluster_name:$cluster}, 'linear', 3)",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "dashed"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "IP Address Utilization",
              "requests": [
                {
                  "q": "sum:cilium.ip_addresses.count{kube_cluster_name:$cluster} by {family}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Avg Endpoint Regeneration Time",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / query2",
                      "alias": "Avg Regen Time (s)"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "avg:cilium.endpoint.regeneration_time_stats.seconds.sum{kube_cluster_name:$cluster}",
                      "aggregator": "avg"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "avg:cilium.endpoint.regeneration_time_stats.seconds.count{kube_cluster_name:$cluster}",
                      "aggregator": "avg"
                    }
                  ],
                  "response_format": "timeseries",
                  "display_type": "line"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Kubernetes Integration",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "timeseries",
              "title": "K8s API Calls by Method",
              "requests": [
                {
                  "q": "sum:cilium.k8s_client.api_calls.count{kube_cluster_name:$cluster} by {method}.as_count()",
                  "display_type": "bars"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "K8s API Latency (avg)",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / query2",
                      "alias": "Avg API Latency (s)"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "avg:cilium.k8s_client.api_latency_time.seconds.sum{kube_cluster_name:$cluster}",
                      "aggregator": "avg"
                    },
                    {
                      "data_source": "metrics",
                      "name": "query2",
                      "query": "avg:cilium.k8s_client.api_latency_time.seconds.count{kube_cluster_name:$cluster}",
                      "aggregator": "avg"
                    }
                  ],
                  "response_format": "timeseries",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "K8s API Errors from Cilium Agent",
              "requests": [
                {
                  "q": "sum:cilium.k8s_client.api_calls.count{kube_cluster_name:$cluster,response_code:5*} by {method}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Workqueue Depth",
              "requests": [
                {
                  "q": "avg:cilium.k8s.workqueue.depth{kube_cluster_name:$cluster} by {name}",
                  "display_type": "line"
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Operator / Control-plane",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "note",
              "content": "**AKS note:** IPAM is Azure-delegated. `cilium.operator.ipam.*` metrics may show limited data as Azure VNET manages pod IPs directly. LB-IPAM is not used on AKS.",
              "background_color": "yellow",
              "font_size": "14",
              "text_align": "left",
              "show_tick": false
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Operator IPAM - IPs by Type",
              "requests": [
                {
                  "q": "avg:cilium.operator.ipam.ips{kube_cluster_name:$cluster} by {type}",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Operator IPAM - Nodes by Category",
              "requests": [
                {
                  "q": "avg:cilium.operator.ipam.nodes{kube_cluster_name:$cluster} by {category}",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "CES Sync Errors",
              "requests": [
                {
                  "q": "sum:cilium.operator.ces.sync_errors.count{kube_cluster_name:$cluster}.as_count()",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Agent + Operator Resources",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "timeseries",
              "title": "Agent CPU by Host (with Outlier Detection)",
              "requests": [
                {
                  "q": "outliers(avg:cilium.process.cpu.seconds.count{kube_cluster_name:$cluster} by {host}.as_rate(), 'DBSCAN', 3)",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Agent Memory by Host (with Outlier Detection)",
              "requests": [
                {
                  "q": "outliers(avg:cilium.process.resident_memory.bytes{kube_cluster_name:$cluster} by {host}, 'DBSCAN', 3)",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Operator CPU",
              "requests": [
                {
                  "q": "avg:cilium.operator.process.cpu.seconds.count{kube_cluster_name:$cluster}.as_rate()",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Operator Memory",
              "requests": [
                {
                  "q": "avg:cilium.operator.process.resident_memory.bytes{kube_cluster_name:$cluster}",
                  "display_type": "line"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "File Descriptor Utilization (open vs max)",
              "requests": [
                {
                  "q": "avg:cilium.process.open_fds{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line"
                },
                {
                  "q": "avg:cilium.process.max_fds{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "line_type": "dashed"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "definition": {
        "type": "group",
        "title": "Node Health Overview (AKS)",
        "layout_type": "ordered",
        "widgets": [
          {
            "definition": {
              "type": "note",
              "content": "**Node Health Overview** provides full visibility into AKS node resources: CPU, memory, disk, network, load, and Kubernetes scheduling state. Uses `system.*` metrics from the Agent DaemonSet, `kubernetes.*` from the Kubelet, and `kubernetes_state.node.*` from the KSM Core check.\n\n**Tip:** Set **$node** to drill into a specific node. Green = healthy, yellow = warning, red = critical.",
              "background_color": "gray",
              "font_size": "14",
              "text_align": "left",
              "show_tick": false
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Total Nodes",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.count{kube_cluster_name:$cluster}",
                  "aggregator": "last"
                }
              ],
              "precision": 0,
              "autoscale": true
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Nodes Ready",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.by_condition{kube_cluster_name:$cluster,condition:ready,status:true}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Nodes NotReady",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.by_condition{kube_cluster_name:$cluster,condition:ready,status:false}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Nodes w/ MemoryPressure",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.by_condition{kube_cluster_name:$cluster,condition:memorypressure,status:true}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Nodes w/ DiskPressure",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.by_condition{kube_cluster_name:$cluster,condition:diskpressure,status:true}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Nodes w/ PIDPressure",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.by_condition{kube_cluster_name:$cluster,condition:pidpressure,status:true}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Unschedulable Nodes",
              "requests": [
                {
                  "q": "sum:kubernetes_state.node.status{kube_cluster_name:$cluster,status:unschedulable}",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 0,
                      "palette": "white_on_yellow"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "hostmap",
              "title": "Node CPU Utilization Heatmap",
              "requests": {
                "fill": {
                  "q": "avg:system.cpu.user{kube_cluster_name:$cluster,host:$node} by {host} + avg:system.cpu.system{kube_cluster_name:$cluster,host:$node} by {host}"
                }
              },
              "node_type": "host",
              "scope": [
                "kube_cluster_name:$cluster"
              ],
              "group": [
                "availability-zone"
              ],
              "no_metric_hosts": false,
              "no_group_hosts": true,
              "style": {
                "palette": "green_to_orange",
                "palette_flip": false
              }
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "CPU Usage by Node (%)",
              "requests": [
                {
                  "q": "avg:system.cpu.user{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:system.cpu.system{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "warm"
                  }
                },
                {
                  "q": "avg:system.cpu.iowait{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "orange",
                    "line_type": "dashed"
                  }
                }
              ],
              "yaxis": {
                "include_zero": true,
                "max": "100"
              },
              "markers": [
                {
                  "value": "y = 80",
                  "display_type": "warning dashed",
                  "label": "Warning 80%"
                },
                {
                  "value": "y = 95",
                  "display_type": "error dashed",
                  "label": "Critical 95%"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "CPU Stolen (Hypervisor) by Node",
              "requests": [
                {
                  "q": "avg:system.cpu.stolen{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                }
              ],
              "markers": [
                {
                  "value": "y = 5",
                  "display_type": "warning dashed",
                  "label": "Steal > 5% = noisy neighbor"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Avg Memory Usable %",
              "requests": [
                {
                  "q": "avg:system.mem.pct_usable{kube_cluster_name:$cluster,host:$node} * 100",
                  "aggregator": "last",
                  "conditional_formats": [
                    {
                      "comparator": ">",
                      "value": 20,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": ">",
                      "value": 10,
                      "palette": "white_on_yellow"
                    },
                    {
                      "comparator": "<=",
                      "value": 10,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 1,
              "autoscale": false,
              "custom_unit": "%"
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Memory Usage by Node",
              "requests": [
                {
                  "q": "avg:system.mem.used{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:system.mem.total{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "grey",
                    "line_type": "dashed"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "K8s Memory: Requests vs Allocatable vs Usage (by node)",
              "requests": [
                {
                  "q": "avg:kubernetes.memory.usage{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:kubernetes_state.node.memory_allocatable{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "grey",
                    "line_type": "dashed"
                  }
                },
                {
                  "q": "sum:kubernetes.memory.requests{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "dotted"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "K8s CPU: Requests vs Allocatable vs Usage (by node)",
              "requests": [
                {
                  "q": "avg:kubernetes.cpu.usage.total{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:kubernetes_state.node.cpu_allocatable{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "grey",
                    "line_type": "dashed"
                  }
                },
                {
                  "q": "sum:kubernetes.cpu.requests{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "dotted"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Disk Usage % by Node",
              "requests": [
                {
                  "q": "avg:system.disk.in_use{kube_cluster_name:$cluster,host:$node} by {host} * 100",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                }
              ],
              "yaxis": {
                "include_zero": true,
                "max": "100"
              },
              "markers": [
                {
                  "value": "y = 80",
                  "display_type": "warning dashed",
                  "label": "Warning 80%"
                },
                {
                  "value": "y = 90",
                  "display_type": "error dashed",
                  "label": "Critical 90%"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Disk I/O Utilization by Node",
              "requests": [
                {
                  "q": "avg:system.io.util{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "warm"
                  }
                }
              ],
              "markers": [
                {
                  "value": "y = 80",
                  "display_type": "warning dashed",
                  "label": "High I/O 80%"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Network Throughput by Node (bytes/s)",
              "requests": [
                {
                  "q": "avg:system.net.bytes_rcvd{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:system.net.bytes_sent{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "warm"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Network Errors & Drops by Node",
              "requests": [
                {
                  "q": "sum:system.net.packets_in.error{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "bars",
                  "style": {
                    "palette": "warm"
                  }
                },
                {
                  "q": "sum:system.net.packets_out.error{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "bars",
                  "style": {
                    "palette": "orange"
                  }
                },
                {
                  "q": "sum:system.net.packets_in.drop{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "bars",
                  "style": {
                    "palette": "red"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "System Conntrack Usage by Node",
              "requests": [
                {
                  "q": "avg:system.net.conntrack.count{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:system.net.conntrack.max{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "grey",
                    "line_type": "dashed"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Normalized Load Average by Node",
              "requests": [
                {
                  "q": "avg:system.load.norm.1{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "dog_classic"
                  }
                },
                {
                  "q": "avg:system.load.norm.5{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool",
                    "line_type": "dashed"
                  }
                },
                {
                  "q": "avg:system.load.norm.15{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "warm",
                    "line_type": "dotted"
                  }
                }
              ],
              "markers": [
                {
                  "value": "y = 1",
                  "display_type": "warning dashed",
                  "label": "Fully loaded (norm=1)"
                },
                {
                  "value": "y = 2",
                  "display_type": "error dashed",
                  "label": "Overloaded (norm=2)"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "toplist",
              "title": "Top Nodes by Running Pods",
              "requests": [
                {
                  "q": "top(avg:kubernetes.pods.running{kube_cluster_name:$cluster} by {host}, 20, 'last', 'desc')"
                }
              ]
            }
          },
          {
            "definition": {
              "type": "timeseries",
              "title": "Pods Running vs Allocatable (by node)",
              "requests": [
                {
                  "q": "avg:kubernetes.pods.running{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "cool"
                  }
                },
                {
                  "q": "avg:kubernetes_state.node.pods_allocatable{kube_cluster_name:$cluster,host:$node} by {host}",
                  "display_type": "line",
                  "style": {
                    "palette": "grey",
                    "line_type": "dashed"
                  }
                }
              ]
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "Avg Node Uptime (days)",
              "requests": [
                {
                  "formulas": [
                    {
                      "formula": "query1 / 86400"
                    }
                  ],
                  "queries": [
                    {
                      "data_source": "metrics",
                      "name": "query1",
                      "query": "avg:system.uptime{kube_cluster_name:$cluster,host:$node}",
                      "aggregator": "last"
                    }
                  ],
                  "response_format": "scalar"
                }
              ],
              "precision": 1,
              "autoscale": false,
              "custom_unit": "days"
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "OOM Kills (last timeframe)",
              "requests": [
                {
                  "q": "sum:oom_kill.oom_process.count{kube_cluster_name:$cluster,host:$node}.as_count()",
                  "aggregator": "sum",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 0,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": "<=",
                      "value": 5,
                      "palette": "white_on_yellow"
                    },
                    {
                      "comparator": ">",
                      "value": 5,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 0
            }
          },
          {
            "definition": {
              "type": "query_value",
              "title": "TCP Queue Max Read Buffer %",
              "requests": [
                {
                  "q": "max:tcp_queue.read_buffer_max_usage_pct{kube_cluster_name:$cluster,host:$node}",
                  "aggregator": "max",
                  "conditional_formats": [
                    {
                      "comparator": "<=",
                      "value": 50,
                      "palette": "white_on_green"
                    },
                    {
                      "comparator": "<=",
                      "value": 80,
                      "palette": "white_on_yellow"
                    },
                    {
                      "comparator": ">",
                      "value": 80,
                      "palette": "white_on_red"
                    }
                  ]
                }
              ],
              "precision": 1,
              "custom_unit": "%"
            }
          }
        ]
      }
    }
  ]
}